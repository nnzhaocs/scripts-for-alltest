\subsection{Design}
\label{sec:design}

We designed \sysname\ so that the interface between the Docker clients and the
registry remains the unchanged.
%
As such, no modifications are needed in the Docker clients.
%
Below we describe the actions that \sysname\ takes during the layer pushes and
pulls.
%
For the sake of this paper, we explain only the main steps omitting smaller
details.

\paragraph{Push}
%
\sysname\ does not unpack the layer immedieately after receiving it from a
client.
%
Instead, \sysname\ saves the layer's compressed tarball in a persistent
\emph{staging area}.
%
A separate \emph{off-line} deduplication process iterates over the layers in
the staging area and performs the following actions for every layer:
%
\textbf{1)}~uncompresses and unpacks the layer's tarball into individual files;
%
\textbf{2)}~computes a \emph{fingerprint} for every file in the layer;
%
\textbf{3)}~checks all file fingerprints against the \emph{file index} to
identify if identical files are already stored in \sysname;
%
\textbf{4)}~stores non-deduplicated files in \sysname's storage system;
%
\textbf{5)}~creates and stores a \emph{layer recipe} that includes the path,
metatada, and fingerprint of every file in the layer;
%
\textbf{6)}~removes the layer's tarball from the staging area.

We believe that off-line deduplication is appropriate because it allows
keep push latencies percieved by  Docker client low.
%
Layer recipies are identified by layer's digests (see
Section~\ref{sec:background}) and files are identified by their fingeprints.
%
These identifiers are used by the underlying storage to store and retrieve
corresponding objects.
%
For example, if a file system is used as a backend storage, \sysname\ creates a
single file for layer reciepy (named by the fingerprint) and a single file for
actual in-layer file (named by the fingerprint).


\paragraph{Pull}
%
Pulling the layer cannot be postponed to the off-line process as the client is
actively waiting for the layer. 
%
\sysname\ performs the following actions \emph{inline} during the pull request:
%
\textbf{1)}~if layer is still in the staging area, \sysname\ services the layer
directly form there;
%
\textbf{2)}~otherwise, \sysname finds Docker the layer recipe by the layer
digest provided by the client;
%
\textbf{2)}~prepares a directory structure for the layer based on the layer
recipe;
%
\textbf{3)}~packs and compresses the layer's  directory tree into a tarball
%
\textbf{4)}~sends the layer tarball back to the client and discards the tarball.

